import type { ParsedResource } from '../utils/schema-parser'

function capitalize(s: string): string {
  return s.charAt(0).toUpperCase() + s.slice(1)
}

export function generateRouteIndex(resource: ParsedResource): string {
  const { config } = resource
  const { name, pluralName, table, search } = config
  const typeName = capitalize(name)
  const displayName = capitalize(pluralName)

  // Get columns from config or default to all non-hidden fields
  const searchableFields = table?.searchableFields ?? search?.searchableFields ?? []
  const defaultSort = table?.defaultSort ?? { field: 'created_at', order: 'desc' }

  return `// ðŸ”„ GENERATED by codegen

import { createFileRoute, Link, useNavigate } from '@tanstack/react-router'
import { z } from 'zod'
import { useLiveQuery } from '@tanstack/react-db'
import { ${pluralName}Collection } from '@/collections'
import { ${name}Columns } from '@/components/tables/${name}-columns'
import { DataTableVirtual } from '@/components/shared/data-table-virtual'
import { PageHeader } from '@/components/shared/page-header'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Plus, Search } from 'lucide-react'

const searchParamsSchema = z.object({
  search: z.string().optional(),
  sort: z.string().default('${defaultSort.field}'),
  order: z.enum(['asc', 'desc']).default('${defaultSort.order}'),
})

export const Route = createFileRoute('/_app/${pluralName}/')({
  validateSearch: searchParamsSchema,
  component: ${displayName}IndexPage,
})

function ${displayName}IndexPage() {
  const routeNavigate = Route.useNavigate()
  const globalNavigate = useNavigate()
  const { search, sort, order } = Route.useSearch()

  // Live query from TanStack DB
  const { data: items = [], isLoading } = useLiveQuery((q) => {
    let query = q.from({ item: ${pluralName}Collection })

    // Apply search filter
    ${searchableFields.length > 0 ? `if (search) {
      query = query.where(({ item }) =>
        item.${searchableFields[0]}.toLowerCase().includes(search.toLowerCase())
      )
    }` : '// No searchable fields configured'}

    // Apply sorting
    query = query.orderBy(({ item }) => item[sort as keyof typeof item], order)

    return query
  })

  const handleRowClick = (row: (typeof items)[0]) => {
    globalNavigate({ to: '/${pluralName}/$id/edit', params: { id: row.id } })
  }

  return (
    <div className="flex flex-col gap-4">
      <PageHeader
        title="${displayName}"
        description="${config.description ?? `Manage your ${pluralName}`}"
        action={
          <Button asChild>
            <Link to="/${pluralName}/new">
              <Plus className="mr-2 h-4 w-4" />
              New ${typeName}
            </Link>
          </Button>
        }
      />

      <div className="flex items-center gap-4">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search ${pluralName}..."
            value={search ?? ''}
            onChange={(e) =>
              routeNavigate({
                search: (prev) => ({
                  ...prev,
                  search: e.target.value || undefined,
                }),
              })
            }
            className="pl-9"
          />
        </div>
      </div>

      <DataTableVirtual
        columns={${name}Columns}
        data={items}
        isLoading={isLoading}
        onRowClick={handleRowClick}
        maxHeight="calc(100vh - 280px)"
      />
    </div>
  )
}
`
}
